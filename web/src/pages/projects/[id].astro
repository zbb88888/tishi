---
/**
 * /projects/{id} â€” é¡¹ç›®è¯¦æƒ… + LLM ä¸­æ–‡åˆ†ææŠ¥å‘Š
 *
 * æ•°æ®æºï¼šdata/projects/{id}.json + data/snapshots/*.jsonl
 * SSG: getStaticPaths() æšä¸¾æ‰€æœ‰é¡¹ç›®
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import TrendChart from '../../components/TrendChart.astro';
import { getAllProjects, getProject, getProjectSnapshots } from '../../lib/data';

export function getStaticPaths() {
  const projects = getAllProjects();
  return projects.map(p => ({
    params: { id: p.id },
  }));
}

const { id } = Astro.params;
const project = getProject(id!);

if (!project) {
  return Astro.redirect('/404');
}

const snapshots = getProjectSnapshots(project.id, 90);

function formatNumber(n: number): string {
  if (n >= 1000) return `${(n / 1000).toFixed(1)}k`;
  return String(n);
}
---

<BaseLayout title={project.full_name}>
  <a href="/" class="text-sm text-gray-500 hover:text-primary-600">â† è¿”å›æ’è¡Œæ¦œ</a>

  <!-- Project Header -->
  <div class="mt-4 card">
    <div class="flex items-start justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">{project.full_name}</h1>
        {project.description && (
          <p class="mt-2 text-gray-600">{project.description}</p>
        )}
      </div>
      {project.rank != null && (
        <span class="badge-blue text-lg font-bold">#{project.rank}</span>
      )}
    </div>

    <!-- Stats -->
    <div class="mt-6 flex flex-wrap gap-6">
      <div class="text-center">
        <div class="text-2xl font-bold text-yellow-500">â­ {formatNumber(project.stars)}</div>
        <div class="text-xs text-gray-400">Stars</div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-gray-600">ğŸ´ {formatNumber(project.forks)}</div>
        <div class="text-xs text-gray-400">Forks</div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-green-600">ğŸ“Š {project.score.toFixed(1)}</div>
        <div class="text-xs text-gray-400">è¯„åˆ†</div>
      </div>
      {project.language && (
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600">ğŸ’» {project.language}</div>
          <div class="text-xs text-gray-400">è¯­è¨€</div>
        </div>
      )}
      {project.trending?.daily_stars != null && (
        <div class="text-center">
          <div class="text-2xl font-bold text-orange-500">ğŸ”¥ +{project.trending.daily_stars}</div>
          <div class="text-xs text-gray-400">ä»Šæ—¥ Star</div>
        </div>
      )}
    </div>

    <!-- Topics -->
    {project.topics && project.topics.length > 0 && (
      <div class="mt-6 flex flex-wrap gap-2">
        {project.topics.map(topic => (
          <span class="badge-green">{topic}</span>
        ))}
      </div>
    )}

    <!-- Categories -->
    {project.categories && project.categories.length > 0 && (
      <div class="mt-4 flex flex-wrap gap-2">
        {project.categories.map(cat => (
          <a href={`/categories/${cat.slug}`}
             class="badge-blue hover:bg-blue-200 transition-colors">
            {cat.slug}
          </a>
        ))}
      </div>
    )}

    <!-- Actions -->
    <div class="mt-6 flex gap-3">
      <a href={`https://github.com/${project.full_name}`}
         target="_blank" rel="noopener"
         class="inline-flex items-center gap-2 rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-700 transition-colors">
        GitHub â†’
      </a>
      {project.homepage && (
        <a href={project.homepage}
           target="_blank" rel="noopener"
           class="inline-flex items-center gap-2 rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
          å®˜ç½‘ â†’
        </a>
      )}
    </div>
  </div>

  <!-- LLM Analysis -->
  {project.analysis && project.analysis.status === 'published' && (
    <div class="mt-6 card">
      <h2 class="text-xl font-bold text-gray-900 mb-4">ğŸ“‹ é¡¹ç›®åˆ†æï¼ˆAI ç”Ÿæˆï¼‰</h2>

      {project.analysis.summary && (
        <p class="text-lg text-primary-700 font-medium mb-4">{project.analysis.summary}</p>
      )}

      {project.analysis.positioning && (
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-1">å®šä½</h3>
          <p class="text-gray-700">{project.analysis.positioning}</p>
        </div>
      )}

      {project.analysis.features && project.analysis.features.length > 0 && (
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-2">æ ¸å¿ƒåŠŸèƒ½</h3>
          <ul class="space-y-1">
            {project.analysis.features.map(f => (
              <li class="text-gray-700">
                <span class="font-medium">{f.name}</span>
                {f.desc && <span class="text-gray-500"> â€” {f.desc}</span>}
              </li>
            ))}
          </ul>
        </div>
      )}

      {project.analysis.advantages && (
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-1">æŠ€æœ¯ä¼˜åŠ¿</h3>
          <p class="text-gray-700">{project.analysis.advantages}</p>
        </div>
      )}

      {project.analysis.tech_stack && (
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-1">æŠ€æœ¯æ ˆ</h3>
          <p class="text-gray-700">{project.analysis.tech_stack}</p>
        </div>
      )}

      {project.analysis.use_cases && (
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-1">é€‚ç”¨åœºæ™¯</h3>
          <p class="text-gray-700">{project.analysis.use_cases}</p>
        </div>
      )}

      {project.analysis.comparison && project.analysis.comparison.length > 0 && (
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-2">åŒç±»å¯¹æ¯”</h3>
          <div class="space-y-2">
            {project.analysis.comparison.map(c => (
              <div class="flex gap-2 text-gray-700">
                <span class="font-medium shrink-0">vs {c.project}</span>
                <span class="text-gray-500">â€” {c.diff}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {project.analysis.ecosystem && (
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-500 uppercase mb-1">ç”Ÿæ€</h3>
          <p class="text-gray-700">{project.analysis.ecosystem}</p>
        </div>
      )}

      <div class="mt-4 pt-4 border-t border-gray-100 text-xs text-gray-400">
        æ¨¡å‹: {project.analysis.model} Â· ç”Ÿæˆäº {new Date(project.analysis.generated_at).toLocaleDateString('zh-CN')}
        {project.analysis.reviewed_at && (
          <span> Â· å®¡æ ¸äº {new Date(project.analysis.reviewed_at).toLocaleDateString('zh-CN')}</span>
        )}
      </div>
    </div>
  )}

  <!-- Trend Chart -->
  {snapshots.length > 0 && (
    <div class="mt-6 card">
      <TrendChart projectName={project.full_name} snapshots={snapshots} />
    </div>
  )}
</BaseLayout>
