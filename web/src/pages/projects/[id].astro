---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TrendChart from '../../components/TrendChart.astro';
import { getProject, type Project } from '../../lib/api';

const { id } = Astro.params;

let project: Project | null = null;
let error: string | null = null;

try {
  if (id) {
    const res = await getProject(Number(id));
    project = res.data;
  }
} catch (e) {
  error = 'é¡¹ç›®æœªæ‰¾åˆ°';
}

function formatNumber(n: number): string {
  if (n >= 1000) return `${(n / 1000).toFixed(1)}k`;
  return String(n);
}
---

<BaseLayout title={project?.full_name || 'é¡¹ç›®è¯¦æƒ…'}>
  {error || !project ? (
    <div class="card text-center text-gray-500 py-12">
      <p class="text-lg">{error || 'é¡¹ç›®ä¸å­˜åœ¨'}</p>
      <a href="/" class="mt-4 inline-block text-primary-600 hover:underline">â† è¿”å›æ’è¡Œæ¦œ</a>
    </div>
  ) : (
    <div>
      <a href="/" class="text-sm text-gray-500 hover:text-primary-600">â† è¿”å›æ’è¡Œæ¦œ</a>

      <div class="mt-4 card">
        <div class="flex items-start justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">{project.full_name}</h1>
            {project.description && (
              <p class="mt-2 text-gray-600">{project.description}</p>
            )}
          </div>
          {project.rank != null && (
            <span class="badge-blue text-lg font-bold">#{project.rank}</span>
          )}
        </div>

        <div class="mt-6 flex flex-wrap gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-yellow-500">â­ {formatNumber(project.stars)}</div>
            <div class="text-xs text-gray-400">Stars</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-gray-600">ğŸ´ {formatNumber(project.forks)}</div>
            <div class="text-xs text-gray-400">Forks</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">ğŸ“Š {project.score.toFixed(1)}</div>
            <div class="text-xs text-gray-400">è¯„åˆ†</div>
          </div>
          {project.language && (
            <div class="text-center">
              <div class="text-2xl font-bold text-blue-600">ğŸ’» {project.language}</div>
              <div class="text-xs text-gray-400">è¯­è¨€</div>
            </div>
          )}
        </div>

        {project.topics && project.topics.length > 0 && (
          <div class="mt-6 flex flex-wrap gap-2">
            {project.topics.map((topic: string) => (
              <span class="badge-green">{topic}</span>
            ))}
          </div>
        )}

        <div class="mt-6 flex gap-3">
          <a href={project.github_url || `https://github.com/${project.full_name}`}
             target="_blank" rel="noopener"
             class="inline-flex items-center gap-2 rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-700 transition-colors">
            GitHub â†’
          </a>
        </div>
      </div>

      <!-- Trend Chart -->
      <div class="mt-6 card">
        <TrendChart projectId={project.id} projectName={project.full_name} />
      </div>
    </div>
  )}
</BaseLayout>
