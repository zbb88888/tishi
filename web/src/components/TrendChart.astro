---
/**
 * TrendChart â€” ä½¿ç”¨ Chart.js æ¸²æŸ“é¡¹ç›® Star/Fork è¶‹åŠ¿å›¾
 *
 * v1.0: æ•°æ®åœ¨æ„å»ºæ—¶ä» snapshots æ³¨å…¥ï¼ŒChart.js ä» CDN æƒ°æ€§åŠ è½½ã€‚
 * æ¯ä¸ªé¡¹ç›®é¡µç‹¬ç«‹ HTML æ–‡ä»¶ï¼Œdefine:vars æ³¨å…¥è¯¥é¡¹ç›®çš„å¿«ç…§æ•°æ®ã€‚
 */
import type { Snapshot } from '../lib/data';

interface Props {
  projectName: string;
  snapshots: Snapshot[];
}

const { projectName, snapshots } = Astro.props;

// æ„å»ºæ—¶é¢„å¤„ç†å›¾è¡¨æ•°æ®
const chartData = {
  labels: snapshots.map(s => {
    const d = new Date(s.date);
    return `${d.getMonth() + 1}/${d.getDate()}`;
  }),
  stars: snapshots.map(s => s.stars),
  forks: snapshots.map(s => s.forks),
};

const chartId = `chart-${Math.random().toString(36).slice(2, 8)}`;
---

<div class="trend-chart-wrapper" id={chartId}>
  <h2 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“ˆ è¶‹åŠ¿å›¾ â€” {projectName}</h2>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="bg-gray-50 rounded-lg p-4">
      <canvas class="stars-canvas" height="200"></canvas>
    </div>
    <div class="bg-gray-50 rounded-lg p-4">
      <canvas class="forks-canvas" height="200"></canvas>
    </div>
  </div>

  <div class="mt-3 text-center text-xs text-gray-400">
    å…± {snapshots.length} ä¸ªæ•°æ®ç‚¹
  </div>
</div>

<script define:vars={{ chartData, chartId }}>
  function renderCharts() {
    const wrapper = document.getElementById(chartId);
    if (!wrapper) return;

    const starsCanvas = wrapper.querySelector('.stars-canvas');
    const forksCanvas = wrapper.querySelector('.forks-canvas');
    if (!starsCanvas || !forksCanvas) return;

    const Chart = window.Chart;
    if (!Chart) return;

    const commonOpts = {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleFont: { size: 12 },
          bodyFont: { size: 11 },
        },
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { font: { size: 10 }, maxTicksLimit: 10 },
        },
        y: {
          grid: { color: 'rgba(0,0,0,0.04)' },
          ticks: { font: { size: 10 } },
        },
      },
    };

    new Chart(starsCanvas, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'â­ Stars',
          data: chartData.stars,
          borderColor: '#eab308',
          backgroundColor: 'rgba(234,179,8,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: chartData.labels.length > 30 ? 0 : 3,
        }],
      },
      options: {
        ...commonOpts,
        plugins: {
          ...commonOpts.plugins,
          title: { display: true, text: 'Stars', font: { size: 13 } },
        },
      },
    });

    new Chart(forksCanvas, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'ğŸ´ Forks',
          data: chartData.forks,
          borderColor: '#6b7280',
          backgroundColor: 'rgba(107,114,128,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: chartData.labels.length > 30 ? 0 : 3,
        }],
      },
      options: {
        ...commonOpts,
        plugins: {
          ...commonOpts.plugins,
          title: { display: true, text: 'Forks', font: { size: 13 } },
        },
      },
    });
  }

  // æƒ°æ€§åŠ è½½ Chart.js CDN
  if (window.Chart) {
    renderCharts();
  } else {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js';
    s.onload = renderCharts;
    document.head.appendChild(s);
  }
</script>
